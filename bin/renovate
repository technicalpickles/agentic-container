#!/usr/bin/env bash

# renovate wrapper
#
# Usage: bin/renovate [renovate-args...]
# Wraps Docker execution of renovate with proper environment and volume mounting

set -euo pipefail

# Check if Docker is available
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker is required but not available" >&2
    echo "Install Docker: https://docs.docker.com/get-docker/" >&2
    exit 1
fi

# Prepare Docker environment variables
DOCKER_ENV_ARGS=()

# Pass through important environment variables
ENV_VARS=(
    "GITHUB_TOKEN"
    "RENOVATE_TOKEN" 
    "LOG_LEVEL"
    "RENOVATE_CONFIG_FILE"
    "RENOVATE_DRY_RUN"
)

for var in "${ENV_VARS[@]}"; do
    if [[ -n "${!var:-}" ]]; then
        DOCKER_ENV_ARGS+=("-e" "$var=${!var}")
    fi
done

# Run renovate in Docker with current directory mounted
if [[ ${#DOCKER_ENV_ARGS[@]} -gt 0 ]]; then
    exec docker run --rm \
        -v "$PWD:/usr/src/app" \
        -w /usr/src/app \
        "${DOCKER_ENV_ARGS[@]}" \
        ghcr.io/renovatebot/renovate:latest \
        "$@"
else
    exec docker run --rm \
        -v "$PWD:/usr/src/app" \
        -w /usr/src/app \
        ghcr.io/renovatebot/renovate:latest \
        "$@"
fi
