name: Build, Test, and Publish

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Rebuild weekly to get latest base image updates
    - cron: "0 2 * * 0"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      base-dockerfile: ${{ steps.changes.outputs.base-dockerfile }}
      cookbook-dockerfiles: ${{ steps.changes.outputs.cookbook-dockerfiles }}
      docs-only: ${{ steps.changes.outputs.docs-only }}
      any-code: ${{ steps.changes.outputs.any-code }}
      changed-cookbooks: ${{ steps.changes.outputs.changed-cookbooks }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        run: |
          # Get the base commit for comparison
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, compare with previous commit
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "Comparing $BASE_SHA..$HEAD_SHA"
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Initialize outputs
          BASE_DOCKERFILE=false
          COOKBOOK_DOCKERFILES=false
          DOCS_ONLY=true
          ANY_CODE=false
          CHANGED_COOKBOOKS=""
          
          # Check each changed file
          while IFS= read -r file; do
            echo "Checking file: $file"
            
            # Check if base Dockerfile changed
            if [[ "$file" == "Dockerfile" ]]; then
              BASE_DOCKERFILE=true
              ANY_CODE=true
              DOCS_ONLY=false
              echo "Base Dockerfile changed"
            fi
            
            # Check if cookbook Dockerfiles changed
            if [[ "$file" =~ ^docs/cookbooks/[^/]+/Dockerfile ]]; then
              COOKBOOK_DOCKERFILES=true
              ANY_CODE=true
              DOCS_ONLY=false
              # Extract cookbook name
              COOKBOOK=$(echo "$file" | sed 's|docs/cookbooks/\([^/]*\)/.*|\1|')
              if [[ -n "$CHANGED_COOKBOOKS" ]]; then
                CHANGED_COOKBOOKS="$CHANGED_COOKBOOKS,$COOKBOOK"
              else
                CHANGED_COOKBOOKS="$COOKBOOK"
              fi
              echo "Cookbook Dockerfile changed: $COOKBOOK"
            fi
            
            # Check if any non-docs files changed
            if [[ ! "$file" =~ ^docs/ ]] && [[ "$file" != "README.md" ]] && [[ ! "$file" =~ \.md$ ]]; then
              ANY_CODE=true
              DOCS_ONLY=false
              echo "Code file changed: $file"
            fi
          done <<< "$CHANGED_FILES"
          
          # Remove duplicates from changed cookbooks
          CHANGED_COOKBOOKS=$(echo "$CHANGED_COOKBOOKS" | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
          
          echo "base-dockerfile=$BASE_DOCKERFILE" >> $GITHUB_OUTPUT
          echo "cookbook-dockerfiles=$COOKBOOK_DOCKERFILES" >> $GITHUB_OUTPUT  
          echo "docs-only=$DOCS_ONLY" >> $GITHUB_OUTPUT
          echo "any-code=$ANY_CODE" >> $GITHUB_OUTPUT
          echo "changed-cookbooks=$CHANGED_COOKBOOKS" >> $GITHUB_OUTPUT
          
          echo "Final outputs:"
          echo "  base-dockerfile: $BASE_DOCKERFILE"
          echo "  cookbook-dockerfiles: $COOKBOOK_DOCKERFILES"
          echo "  docs-only: $DOCS_ONLY"
          echo "  any-code: $ANY_CODE"
          echo "  changed-cookbooks: $CHANGED_COOKBOOKS"

  build-standard:
    name: Build Standard Image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-code == 'true' || github.event_name == 'schedule'
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-metadata: ${{ steps.meta.outputs.json }}
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --allow-insecure-entitlement security.insecure

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=main,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          target: standard
          # Use single platform for PRs (enables load), multi-platform for main branch
          platforms: ${{ github.event_name == 'pull_request' && 'linux/amd64' || 'linux/amd64,linux/arm64' }}
          push: ${{ github.event_name != 'pull_request' }}
          load: ${{ github.event_name == 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Enhanced caching with scope isolation
          cache-from: |
            type=gha,scope=standard-${{ github.ref_name }}
            type=gha,scope=standard-main
          cache-to: type=gha,mode=max,scope=standard-${{ github.ref_name }}
          # Use secret mounting for GITHUB_TOKEN to avoid rate limits securely
          secrets: |
            github_token=${{ secrets.GITHUB_TOKEN }}
          # Build args can be customized here if needed:
          # build-args: |
          #   NODE_VERSION=20.17.0
          #   PYTHON_VERSION=3.12.6

      - name: Export image for testing (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # For PRs, we need to make the image available for cookbook testing
          # Tag it with a consistent name for the test jobs
          docker tag ${{ steps.meta.outputs.tags }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-base

          # Save image to a tarball for sharing with parallel jobs
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-base > /tmp/base-image.tar

      - name: Upload base image artifact (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: base-image
          path: /tmp/base-image.tar
          retention-days: 1

  parallel-validation:
    name: Parallel Validation
    needs: [detect-changes, build-standard]
    runs-on: ubuntu-latest
    if: always() && (needs.build-standard.result == 'success' || needs.build-standard.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Dev build only runs for base dockerfile changes or schedule
          - job: build-dev
            name: Build Dev Image
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || github.event_name == 'schedule' }}
          # Test all cookbooks if base dockerfile changed, or only changed cookbooks otherwise
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: python-cli
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'python-cli') || github.event_name == 'schedule' }}
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: nodejs-backend
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'nodejs-backend') || github.event_name == 'schedule' }}
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: go-microservices
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'go-microservices') || github.event_name == 'schedule' }}
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: rails-fullstack
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'rails-fullstack') || github.event_name == 'schedule' }}
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: react-frontend
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'react-frontend') || github.event_name == 'schedule' }}
          - job: test-cookbooks
            name: Test Cookbooks
            cookbook: multistage-production
            condition: ${{ needs.detect-changes.outputs.base-dockerfile == 'true' || contains(needs.detect-changes.outputs.changed-cookbooks, 'multistage-production') || github.event_name == 'schedule' }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Dev build specific steps
      - name: Log in to Container Registry (dev build only)
        if: matrix.job == 'build-dev' && matrix.condition == 'true' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract dev metadata
        if: matrix.job == 'build-dev' && matrix.condition == 'true' && github.ref == 'refs/heads/main'
        id: meta-dev
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=dev

      - name: Build dev image
        if: matrix.job == 'build-dev' && matrix.condition == 'true' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          target: dev
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-dev.outputs.tags }}
          labels: ${{ steps.meta-dev.outputs.labels }}
          # Use secret mounting for GITHUB_TOKEN to avoid rate limits securely
          secrets: |
            github_token=${{ secrets.GITHUB_TOKEN }}
          # Enhanced caching that reuses standard build layers
          cache-from: |
            type=gha,scope=dev-${{ github.ref_name }}
            type=gha,scope=dev-main
            type=gha,scope=standard-${{ github.ref_name }}
          cache-to: type=gha,mode=max,scope=dev-${{ github.ref_name }}

      # Cookbook testing specific steps
      - name: Download base image artifact (PR cookbook testing)
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true' && github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: base-image
          path: /tmp/

      - name: Load base image for testing (PR only)
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true' && github.event_name == 'pull_request'
        run: |
          docker load < /tmp/base-image.tar
          docker images

      - name: Pull base image for testing (main branch)
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true' && github.event_name != 'pull_request'
        run: |
          # For main branch builds, pull the just-built image
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-base

      - name: Build cookbook extension image
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true'
        run: |
          echo "🏗️  Building ${{ matrix.cookbook }} cookbook..."
          docker build \
            -f docs/cookbooks/${{ matrix.cookbook }}/Dockerfile \
            -t test-extension-${{ matrix.cookbook }}:latest \
            .

      - name: Run goss tests for cookbook
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true'
        run: |
          echo "🧪 Running goss tests for ${{ matrix.cookbook }} cookbook..."
          ./scripts/test-dockerfile.sh ${{ matrix.cookbook }} test-extension-${{ matrix.cookbook }}:latest

      - name: Clean up test images
        if: matrix.job == 'test-cookbooks' && matrix.condition == 'true' && always()
        run: |
          docker rmi test-extension-${{ matrix.cookbook }}:latest || true
          docker rmi ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-base || true

  # Summary job to provide single status check for cookbook tests
  test-cookbooks-summary:
    name: Cookbook Tests Summary
    runs-on: ubuntu-latest
    needs: parallel-validation
    if: always()
    steps:
      - name: Check cookbook test results
        run: |
          # Check if any cookbook tests failed
          needs_json='${{ toJson(needs) }}'
          echo "Parallel validation results: $needs_json"

          if echo "$needs_json" | jq -e '.["parallel-validation"].result != "success"' > /dev/null; then
            echo "❌ One or more cookbook tests failed"
            echo "This will block publishing to ensure only tested images are released"
            exit 1
          else
            echo "✅ All cookbook tests passed!"
          fi

  publish:
    name: Publish Images
    runs-on: ubuntu-latest
    needs: [build-standard, parallel-validation, test-cookbooks-summary]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.build-standard.result == 'success' && needs.parallel-validation.result == 'success' && needs.test-cookbooks-summary.result == 'success'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Confirm images are ready for publishing
        run: |
          echo "✅ All validation passed - ready to publish images"
          echo "Standard image: ${{ needs.build-standard.outputs.image-tag }}"
          echo "Build digest: ${{ needs.build-standard.outputs.image-digest }}"

          # Images were already pushed during the build step for main branch
          echo "Images have been successfully published to registry"

      - name: Create release summary
        run: |
          {
            echo "## 🚀 Published Images"
            echo ""
            echo "| Image | Status | Tests |"
            echo "|-------|--------|-------|"
            echo "| Standard | ✅ Published | ✅ All cookbooks passed |"
            echo "| Dev | ✅ Published | ✅ Included |"
            echo ""
            echo "**Digest:** \`${{ needs.build-standard.outputs.image-digest }}\`"
            echo ""
            echo "All cookbook extensions have been validated against these images."
          } >> "$GITHUB_STEP_SUMMARY"
